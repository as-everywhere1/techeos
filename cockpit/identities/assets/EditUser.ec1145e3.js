import{o as y,c as P,a as f,u as h,g as N,_ as G,i as T,j as K,n as O,w as Y,M as q,h as w,b as v,e as r,t as _,f as D,k as b,F as R,l as x,m as j,r as A,p as $,T as ee,L as Q,d as se,q as L,v as V,s as te,x as oe,y as ae,z as re,A as ne,B as ie,U as le,C as ce,D as de,E as ue}from"./index.f675d030.js";import{P as X,r as he,U as pe,a as fe}from"./UserPassword.375150ff.js";import{r as W,a as me}from"./PlusIcon.13d97b18.js";import{r as ye}from"./TrashIcon.daec6a4c.js";function we(i,s){return y(),P("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[f("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})])}function ge(i,s){return y(),P("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[f("path",{d:"M8 2a1 1 0 000 2h2a1 1 0 100-2H8z"}),f("path",{d:"M3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15v3a2 2 0 01-2 2H5a2 2 0 01-2-2V5zM15 11h2a1 1 0 110 2h-2v-2z"})])}function Se(i,s){return y(),P("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[f("path",{"fill-rule":"evenodd",d:"M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z","clip-rule":"evenodd"})])}function be(i,s){return y(),P("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[f("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z","clip-rule":"evenodd"})])}class ve{constructor(s,t){var n;const e={...t};this.failIfDNE=e.dne==="fail",delete e.dne,this.persistStat=(n=e.persistStat)!=null?n:!1,delete e.persistStat,this.fileHandle=cockpit.file(s,e),this.hookedFileHandle={...this.fileHandle,read:this.read,replace:this.replace,modify:this.modify,close:this.close},this.path=s}read(){return this.failIfDNE?new Promise((s,t)=>{this.fileHandle.read().then((e,n)=>{e===null&&n==="-"?t(new Error("File does not exist: "+this.path)):s(e,n)}).catch(e=>t(e))}):this.fileHandle.read()}replace(s,t){return this.persistStat?new Promise(async(e,n)=>{await this.getStat(),this.fileHandle.replace(s,t).then((c,p)=>this.setStat().then(()=>e(c,p)).catch(u=>n(u))).catch(c=>n(c))}):this.fileHandle.replace(s,t)}modify(s,t,e){return this.persistStat?new Promise(async(n,c)=>{await this.getStat(),this.fileHandle.modify(s,t,e).then((p,u)=>this.setStat().then(()=>n(p,u)).catch(d=>c(d))).catch(p=>c(p))}):this.fileHandle.modify(s,t,e)}watch(s,t){return this.hookedFileHandle.watch(s,t)}close(){return this.fileHandle.close()}async getStat(){try{const s=(await h(["stat",this.path,"--format=%u:%g:%a"]).promise()).stdout.split(":").map(t=>t.trim());return this.stat={uid:s[0],gid:s[1],permissions:s[2]},{...this.stat}}catch(s){throw new Error(N(s))}}async setStat(s={}){const t={...this.stat,...s};let e="";if(t.uid&&(e+=t.uid),t.gid&&(e+=":"+t.gid),e)try{await h(["chown",e,this.path]).promise()}catch(n){throw new Error(N(n))}if(t.permissions)try{await h(["chmod",t.permissions,this.path]).promise()}catch(n){throw new Error(N(n))}this.stat=t}}const _e={props:{user:String},setup(i,{emit:s}){const t=T({showModal:!1,showRemoveModal:!1,isSet:!1}),e=K(O),n=async()=>{s("startProcessing");try{await h(["pdbedit","-L","-u",i.user],{superuser:"try"}).promise(),t.isSet=!0}catch{t.isSet=!1}finally{s("stopProcessing")}},c=async u=>{s("startProcessing");try{const d=h(["smbpasswd","-a","-s",i.user],{superuser:"try"});d.proc.input(`${u}
${u}
`),await d.promise(),t.isSet=!0,e.value.constructNotification("Set Samba password",`Samba password for ${i.user} was set successfully.`,"success")}catch(d){e.value.constructNotification(`Failed to set Samba password for ${i.user}`,x(d),"error"),n()}finally{t.showModal=!1,s("stopProcessing")}},p=async()=>{s("startProcessing");try{await h(["smbpasswd","-x",i.user],{superuser:"try"}).promise(),t.isSet=!1,e.value.constructNotification("Removed Samba password",`Samba password for ${i.user} was removed successfully.`,"success")}catch(u){e.value.constructNotification(`Failed to remove Samba password for ${i.user}`,x(u),"error"),n()}finally{t.showRemoveModal=!1,s("stopProcessing")}};return Y(i.user,()=>{n()},{immediate:!0}),{sambaPassword:t,checkIfSmbpasswdSet:n,setSambaPassword:c,removeSambaPassword:p}},components:{ModalPopup:q,PasswordModal:X,ExclamationCircleIcon:W},emits:["startProcessing","stopProcessing"]},Ce=r("label",{class:"block text-label"},"Samba",-1),xe={class:"button-group-row-wrap"},ke=j(" They will no longer be able to access Samba shares. ");function Pe(i,s,t,e,n,c){const p=w("PasswordModal"),u=w("ExclamationCircleIcon"),d=w("ModalPopup");return y(),v(R,null,[r("div",null,[Ce,r("div",xe,[r("button",{class:"btn btn-primary",onClick:s[0]||(s[0]=S=>e.sambaPassword.showModal=!0)},_(e.sambaPassword.isSet?"Change":"Set")+" Samba Password",1),e.sambaPassword.isSet?(y(),v("button",{key:0,class:"btn btn-primary",onClick:s[1]||(s[1]=S=>e.sambaPassword.showRemoveModal=!0)},"Remove Samba Password")):D("",!0)])]),f(p,{showModal:e.sambaPassword.showModal,user:t.user,headerText:`${e.sambaPassword.isSet?"Change":"Set"} Samba password for ${t.user}`,onApply:e.setSambaPassword,onCancel:s[2]||(s[2]=S=>e.sambaPassword.showModal=!1),requireDifferentFromUser:"",allowEmpty:""},null,8,["showModal","user","headerText","onApply"]),f(d,{showModal:e.sambaPassword.showRemoveModal,headerText:`Remove Samba password for ${t.user}?`,onApply:e.removeSambaPassword,onCancel:s[3]||(s[3]=()=>e.sambaPassword.showRemoveModal=!1),applyText:"Yes",cancelText:"No"},{icon:b(()=>[f(u,{class:"size-icon-xl icon-error"})]),default:b(()=>[ke]),_:1},8,["showModal","headerText","onApply"])],64)}var Me=G(_e,[["render",Pe]]);async function Ie(i){let s,t;try{s=(await h(["mktemp"],{superuser:"try"}).promise()).stdout.trim();const e=h(["dd",`of=${s}`],{superuser:"try"});e.proc.input(i),await e.promise(),t=(await h(["ssh-keygen","-l","-f",s],{superuser:"try"}).promise()).stdout.split(" ")[1]}catch(e){t="Failed to get fingerprint: "+N(e)}finally{s&&h(["rm",s],{superuser:"try"})}return t}const Z={parse:async i=>(await Promise.all(i.split(`
`).filter(s=>!/^(\s*|\s*#.*)$/.test(s)).map(s=>s.replace(/\s*#.*$/,"")).map(async s=>{var c,p;const t={pubKey:s,fingerprint:await Ie(s)},e=new RegExp([/^((?:\w+=(?:"[^"]*"|'[^']*'|(?:[^,\s]|\\\s)*),?)+)?/,/\s*/,/\b(\S+)\b/,/\s*/,/(\S+)/,/\s*/,/(\S*)$/].map(u=>u.source).join("")),n=s.match(e);return n?(t.options=(p=(c=n[1])==null?void 0:c.split(new RegExp(`(?<!\\\\),(?=(?:[^\\"]*\\"[^\\"]*\\")*[^\\"]*$)(?=(?:[^\\']*\\'[^\\']*\\')*[^\\']*$)`,"g")))!=null?p:null,t.algo=n[2],t.pubKey=n[3],t.comment=n[4],t):(console.error("regex match on key failed: "+s),null)}))).filter(s=>s!==null),stringify:i=>{var s;return((s=i.map(t=>{var e,n;return[(n=(e=t.options)==null?void 0:e.join(","))!=null?n:null,t.algo,t.pubKey,t.comment].filter(c=>c!==null).join(" ")}).join(`
`))!=null?s:"")+`
`}},He={superuser:"try",syntax:Z,dne:"fail",persistStat:!0},H=async(i,s)=>{try{return await h(["test",i,s],{superuser:"try"}).promise(),!0}catch(t){if(t.status===1)return!1;throw new Error("Failed to check path: "+s+": "+N(t))}},F=async i=>H("-e",i),B=async i=>{if(await H("-d",i))return await H("-r",i)&&await H("-w",i)&&await H("-x",i);if(await H("-f",i))return await H("-r",i)&&await H("-w",i);throw new Error("Path does not exist: "+i)},Te={props:{user:Object},setup(i,{emit:s}){const t=K(O),e=A([]),n=A(!1),c=T({showModal:!1,key:null,ask:a=>{c.key=a,c.showModal=!0},apply:async()=>{s("startProcessing");try{const a=e.value.filter(o=>o!==c.key);await S.replace(a)}catch(a){t.value.constructNotification("Error removing authorized SSH key",x(a),"error")}finally{c.key=null,c.showModal=!1,s("stopProcessing")}},cancel:()=>{c.key=null,c.showModal=!1}}),p=T({showModal:!1,keyText:"",apply:async()=>{s("startProcessing");try{let a=await Z.parse(p.keyText);if(!a.length){t.value.constructNotification("Error adding authorized SSH key","No keys could be parsed.","error");return}a=[...e.value,...a],await S.replace(a)}catch(a){t.value.constructNotification("Error adding authorized SSH key",x(a),"error")}finally{p.keyText="",p.showModal=!1,s("stopProcessing")}},cancel:()=>{p.keyText="",p.showModal=!1}}),u=T({showPassphraseModal:!1,hasPublicID:!1,checkPublicID:async()=>{u.hasPublicID=await F(`${i.user.home}/.ssh/id_rsa.pub`)},copyID:async()=>{s("startProcessing");try{navigator.clipboard.writeText(await cockpit.file(`${i.user.home}/.ssh/id_rsa.pub`,{superuser:"try"}).read()),t.value.constructNotification("Copied public ID to clipboard","","success")}catch(a){t.value.constructNotification("Error reading public ID",x(a),"error")}finally{s("stopProcessing")}},generateID:async()=>{s("startProcessing");try{u.showPassphraseModal=!0;const a=h(["sudo","-u",i.user.user,"ssh-keygen"],{superuser:"try"});a.proc.input(`${i.user.home}/.ssh/id_rsa
`,!0);let o;try{o=await new Promise((l,g)=>{u.applyPasswordCallback=l,u.cancelPasswordCallback=g})}catch{t.value.constructNotification("SSH key generation canceled"),u.showPassphraseModal=!1;return}a.proc.input(`${o}
${o}`),await a.promise(),t.value.constructNotification("Successfully generated SSH key pair","It can now be copied and used.","success")}catch(a){t.value.constructNotification("Error generating public ID",x(a),"error")}finally{u.showPassphraseModal=!1,s("stopProcessing")}u.checkPublicID()},applyPasswordCallback:()=>{},cancelPasswordCallback:()=>{}}),d=T({showModal:!1,target:"",result:null,message:"",running:!1,test:async()=>{d.running=!0;try{const a=["sudo","-u",i.user.user,"ssh","-o","StrictHostKeyChecking=no","-o","UserKnownHostsFile=/dev/null","-o","PasswordAuthentication=no",d.target,"whoami"],o=(await h(a,{superuser:"try"}).promise()).stdout.trim();d.message=`Successfully logged in as ${o}@${d.target.replace(/^[^@]*@/,"")}`,d.result=!0}catch(a){const o=N(a).split(`
`).filter(l=>!/to the list of known hosts/.test(l)).join(`
`);d.message=`Failed to log in:
${o}`,d.result=!1}finally{d.running=!1}},close:()=>{d.showModal=!1},reset:()=>{d.result=null,d.message=""}});let S=null;const m=async a=>{var o,l;if(!!((o=i.user)!=null&&o.home)){s("startProcessing");try{e.value=(l=await a)!=null?l:[]}catch(g){t.value.constructNotification("Error getting authorized SSH keys",x(g),"error")}finally{s("stopProcessing")}}},k=async a=>{s("startProcessing");try{const o=a.split("/"),l=o.slice(0,o.length-1).join("/");await F(l)||(await h(["mkdir","-p",l],{superuser:"try"}).promise(),await h(["chmod","700",l],{superuser:"try"}).promise(),await h(["chown",`${i.user.user}:${i.user.user}`,l],{superuser:"try"}).promise()),await h(["touch",a],{superuser:"try"}).promise(),await h(["chmod","600",a],{superuser:"try"}).promise(),await h(["chown",`${i.user.user}:${i.user.user}`,a],{superuser:"try"}).promise(),t.value.constructNotification("Fixed missing SSH directory/files","","success")}catch(o){t.value.constructNotification("Failed to create SSH directory / authorized_keys",x(o),"error")}finally{s("stopProcessing")}M()},I=async a=>{const o=a.split("/").slice(0,-1).join("/");return await B(i.user.home)?await F(o)?await B(o)?await F(a)?await B(a)?!0:(t.value.constructNotification("Permission denied for SSH","You cannot manage SSH for this user.","warning"),!1):(t.value.constructNotification("authorized_keys file doesn't exist",`${a} does not exist, but you can create it now.`,"warning").addAction("Fix",()=>k(a)),!1):(t.value.constructNotification("Permission denied for SSH","You cannot manage SSH for this user.","warning"),!1):(t.value.constructNotification("SSH directory doesn't exist",`${o} does not exist, but you can create it now.`,"warning").addAction("Fix",()=>k(a)),!1):(t.value.constructNotification("Permission denied for SSH","You cannot manage SSH for this user.","warning"),!1)};let C=null;const M=async()=>{if(!!i.user.home){s("startProcessing");try{C&&C.remove();const a=`${i.user.home}/.ssh/authorized_keys`;try{n.value=await I(a)}catch(o){t.value.constructNotification("Error checking path: ${}",x(o),"error");return}S=new ve(a,He),C=S.watch(m),u.checkPublicID()}finally{s("stopProcessing")}}};return Y(i.user,()=>{M()},{immediate:!0}),$(()=>{C&&C.remove()}),{keys:e,valid:n,confirmRemoveKey:c,addKey:p,publicID:u,testSSH:d,getKeys:m}},components:{PlusIcon:me,MinusIcon:he,Table:ee,ClipboardCopyIcon:ge,ModalPopup:q,ExclamationCircleIcon:W,PasswordModal:X,CheckCircleIcon:we,MinusCircleIcon:be,LoadingSpinner:Q},emits:["startProcessing","stopProcessing"]},De={key:0},ze=r("label",{class:"block text-label"},"SSH",-1),Ne={class:"space-y-content"},Ee={class:"button-group-row-wrap"},Ke={class:"flex flex-row space-x-2 items-center"},Ae=r("span",null,"Copy SSH Public ID",-1),Fe={class:"flex flex-row justify-between items-center"},Re=r("div",null,"Authorized SSH Access Keys",-1),Le=r("tr",null,[r("th",{scope:"col",class:"sr-only"},"comment"),r("th",{class:"sr-only"},"fingerprint"),r("th",{scope:"col",class:"sr-only"},"Remove")],-1),je={class:"flex flex-row justify-end"},Ue=["onClick"],Be={key:0},Ve=r("td",{class:"text-muted"},"No keys. Click '+' to add one.",-1),Ge=[Ve],Oe=r("div",null,"This cannot be undone.",-1),Ye={class:"text-muted"},qe={class:"flex flex-row gap-2 items-center"},We=r("h3",{class:"text-header"},"Test passwordless SSH",-1),Je=r("label",{class:"text-label block"},"SSH Target",-1),Qe={key:0,class:"feedback-group"};function Xe(i,s,t,e,n,c){const p=w("ClipboardCopyIcon"),u=w("PlusIcon"),d=w("MinusIcon"),S=w("Table"),m=w("ModalPopup"),k=w("ExclamationCircleIcon"),I=w("PasswordModal"),C=w("LoadingSpinner"),M=w("CheckCircleIcon"),a=w("MinusCircleIcon");return y(),v(R,null,[e.valid?(y(),v("div",De,[ze,r("div",Ne,[r("div",Ee,[e.publicID.hasPublicID?(y(),v("button",{key:0,class:"btn btn-primary",onClick:s[0]||(s[0]=(...o)=>e.publicID.copyID&&e.publicID.copyID(...o))},[r("div",Ke,[Ae,f(p,{class:"size-icon"})])])):(y(),v("button",{key:1,class:"btn btn-primary",onClick:s[1]||(s[1]=(...o)=>e.publicID.generateID&&e.publicID.generateID(...o))},"Generate SSH Key Pair")),r("button",{class:"btn btn-secondary",onClick:s[2]||(s[2]=o=>e.testSSH.showModal=!0)},"Test Passwordless SSH")]),f(S,{class:"rounded-lg"},{header:b(()=>[r("div",Fe,[Re,r("button",{onClick:s[3]||(s[3]=o=>e.addKey.showModal=!0)},[f(u,{class:"size-icon icon-default"})])])]),thead:b(()=>[Le]),tbody:b(()=>[(y(!0),v(R,null,se(e.keys,(o,l)=>(y(),v("tr",null,[r("td",null,_(o.comment),1),r("td",null,_(o.fingerprint),1),r("td",je,[r("button",{onClick:g=>e.confirmRemoveKey.ask(o)},[f(d,{class:"size-icon icon-danger"})],8,Ue)])]))),256)),e.keys.length===0?(y(),v("tr",Be,Ge)):D("",!0)]),_:1})])])):D("",!0),f(m,{showModal:e.addKey.showModal,headerText:"Add new authorized SSH key",applyText:"Add",onApply:e.addKey.apply,onCancel:e.addKey.cancel},{default:b(()=>[L(r("textarea",{"onUpdate:modelValue":s[4]||(s[4]=o=>e.addKey.keyText=o),class:"input-textlike w-full h-40 overflow-y-auto",style:{resize:"none"},placeholder:"Begins with 'ssh-rsa', 'ecdsa-sha2-nistp256', 'ecdsa-sha2-nistp384', 'ecdsa-sha2-nistp521', 'ssh-ed25519', 'sk-ecdsa-sha2-nistp256@openssh.com', or 'sk-ssh-ed25519@openssh.com'"},null,512),[[V,e.addKey.keyText]])]),_:1},8,["showModal","onApply","onCancel"]),f(m,{showModal:e.confirmRemoveKey.showModal,headerText:"Remove authorized SSH key?",applyText:"Yes",cancelText:"No",applyDangerous:"",onApply:e.confirmRemoveKey.apply,onCancel:e.confirmRemoveKey.cancel,autoWidth:""},{icon:b(()=>[f(k,{class:"size-icon-xl icon-danger"})]),default:b(()=>{var o,l,g,E;return[Oe,r("div",Ye,"Fingerprint: "+_((l=(o=e.confirmRemoveKey.key)==null?void 0:o.comment)!=null?l:"")+" "+_((E=(g=e.confirmRemoveKey.key)==null?void 0:g.fingerprint)!=null?E:"no key selected"),1)]}),_:1},8,["showModal","onApply","onCancel"]),f(I,{allowEmpty:"",requireDifferentFromUser:"",user:t.user.user,headerText:"Set passphrase for ID (empty for no passphrase)",showModal:e.publicID.showPassphraseModal,onApply:e.publicID.applyPasswordCallback,onCancel:e.publicID.cancelPasswordCallback},null,8,["user","showModal","onApply","onCancel"]),f(m,{showModal:e.testSSH.showModal,headerText:"Test passwordless SSH",applyText:"Test",cancelText:"Close",onApply:e.testSSH.test,onCancel:e.testSSH.close,autoWidth:""},{header:b(()=>[r("div",qe,[We,e.testSSH.running?(y(),P(C,{key:0,class:"size-icon"})):D("",!0)])]),default:b(()=>[Je,L(r("input",{type:"text",class:"input-textlike w-full","onUpdate:modelValue":s[5]||(s[5]=o=>e.testSSH.target=o),onInput:s[6]||(s[6]=(...o)=>e.testSSH.reset&&e.testSSH.reset(...o)),placeholder:"user@hostname or just hostname"},null,544),[[V,e.testSSH.target]]),e.testSSH.result!==null?(y(),v("div",Qe,[e.testSSH.result?(y(),P(M,{key:0,class:"size-icon icon-success"})):(y(),P(a,{key:1,class:"size-icon icon-error"})),r("span",{class:te([e.testSSH.result?"text-success":"text-error","text-feedback whitespace-pre-wrap"])},_(e.testSSH.message),3)])):D("",!0)]),_:1},8,["showModal","onApply","onCancel"])],64)}var Ze=G(Te,[["render",Xe]]);const $e={setup(i,{emit:s}){const t=A(""),e=oe(),n=T({groups:[],isCurrentLoggedIn:!1}),c=A(0),p=A(0),u=K(ae),d=K(O),S=K(re);ne(()=>S.value=!0),ie(()=>S.value=!1);const m=T({showModal:!1,applyText:"Confirm",removeFiles:!1,confirmationCheck:`delete-${n.user}`,confirmationInput:"",confirmed:!1,ask:()=>{m.confirmed=!1,m.confirmationCheck=`delete-${n.user}`,m.confirmationInput="",m.showModal=!0},checkConfirmation:()=>{m.confirmed=m.confirmationCheck===m.confirmationInput},applyCallback:async()=>{m.confirmed&&await M(),m.reset()},cancelCallback:()=>{m.reset()},reset:()=>{m.showModal=!1,setTimeout(()=>{m.confirmationInput="",m.removeFiles=!1},300)}}),k=T({showModal:!1,applyText:"Confirm",applyCallback:async()=>{try{await h(["killall","-HUP","-u",n.user],{superuser:"try"}).promise()}catch{}k.showModal=!1},cancelCallback:()=>{k.showModal=!1}}),I=async(a=null)=>{c.value++;try{a!==null&&(n.user=a),m.confirmationCheck=`delete-${n.user}`,n.isCurrentLoggedIn=n.user===(await cockpit.user()).name;let o={};try{const l=(await h(["getent","passwd",n.user],{superuser:"try"}).promise()).stdout.trim().split(":");o.uid=l[2],o.gid=l[3],o.name=l[4],o.home=l[5],o.shell=u.value.find(g=>g.path===l[6]),o.shell||(d.value.constructNotification(`${l[6]} not in /etc/shells`,"If you modify this user's shell, you will need to use 'Custom Shell' in the dropdown to set it back.","info"),o.shell=ue(l[6])),o.groups=(await h(["groups",n.user],{superuser:"try"}).promise()).stdout.replace(/^[^:]+:\s*/,"").split(/\s+/g).filter(g=>!/^\s*$/.test(g)).sort(),o.primaryGroup=(await h(["id","-ng",n.user],{superuser:"try"}).promise()).stdout.trim()}catch(l){let g;(l==null?void 0:l.status)===2?g=`User '${n.user}' not found.`:g=x(l),d.value.constructNotification("Failed to query user",g,"error"),cockpit.location.go("/users");return}Object.assign(n,o)}finally{c.value--}},C=async a=>{c.value++;let o=!1;try{const l=[];let g=!1;a.name!==n.name&&l.push(h(["chfn","-f",a.name,a.user],{superuser:"try"}).promise()),a.home!==n.home&&l.push(h(["usermod","-m","-d",a.home,a.user],{superuser:"try"}).promise()),a.shell.path!==n.shell.path&&l.push(h(["chsh","-s",a.shell.path,a.user],{superuser:"try"}).promise());const E=a.groups.filter(z=>!n.groups.includes(z)),U=n.groups.filter(z=>!a.groups.includes(z));if(o=Boolean(E.length)||Boolean(U.length),E.length&&l.push(h(["usermod","-aG",E.join(","),a.user],{superuser:"try"}).promise()),U.length)for(const z of U)l.push(h(["gpasswd","-d",a.user,z],{superuser:"try"}).promise());for(const z of l)try{await z}catch(J){alert(`Error applying changes:
`+J.argv.join(" ")+`:
`+N(J)),g=!0}g?await I():Object.assign(n,a)}finally{o&&s("refreshGroups"),c.value--}},M=async()=>{const a=["userdel"];m.removeFiles&&a.push("--remove"),a.push(n.user);try{await h(a,{superuser:"try"}).promise(),d.value.constructNotification("Deleted user",`${n.user} was deleted successfully.`,"success"),s("refreshGroups"),cockpit.location.go("/users")}catch(o){d.value.constructNotification("Error deleting user",x(o),"error")}};return Y(()=>e.path,async()=>{!/^\/users\/.*$/.test(e.path)||await I(e.params.username)},{immediate:!0}),{testOutput:t,user:n,processing:c,processingCredentials:p,deleteConfirmation:m,terminateConfirmation:k,applyChanges:C,deleteUser:M}},components:{UserEditor:pe,SambaPassword:Me,LoadingSpinner:Q,SSHKeys:Ze,UserActivity:le,TrashIcon:ye,ExclamationCircleIcon:W,ModalPopup:q,UserPassword:fe,FixedMenu:ce,LogoutIcon:Se},emits:["refreshGroups"]},es={class:"centered-column p-well space-y-well"},ss={class:"card sticky top-0 z-10"},ts={class:"card-header flex flex-row flex-wrap items-baseline gap-2"},os={class:"text-header"},as={class:"text-muted font-mono text-sm"},rs={key:0},ns={key:1},is={class:"card"},ls={class:"card-header flex flex-row space-x-2 items-center"},cs=r("div",{class:"text-header"},"Details",-1),ds=["disabled","title"],us={class:"flex flex-row items-center"},hs=r("span",{class:"mr-2"},"Delete User",-1),ps=["disabled","title"],fs={class:"flex flex-row items-center"},ms=r("span",{class:"mr-2"},"Terminate Session",-1),ys={class:"card"},ws={class:"card-header flex flex-row space-x-2 items-center"},gs=r("div",{class:"text-header"},"Credentials",-1),Ss={class:"card-body space-y-content"},bs={class:"card overflow-hidden"},vs={class:"flex items-center gap-2 mb-3"},_s={class:"font-medium"},Cs={class:"whitespace-normal mb-3"},xs=j(" This cannot be undone. Type "),ks={class:"font-mono text-sm bg-accent p-1"},Ps=j(" below to confirm. ");function Ms(i,s,t,e,n,c){const p=w("LoadingSpinner"),u=w("TrashIcon"),d=w("LogoutIcon"),S=w("UserEditor"),m=w("UserPassword"),k=w("SambaPassword"),I=w("SSHKeys"),C=w("UserActivity"),M=w("ExclamationCircleIcon"),a=w("ModalPopup");return y(),v(R,null,[r("div",es,[r("div",ss,[r("div",ts,[r("span",os,_(e.user.name===""?e.user.user:e.user.name),1),r("span",as,[e.user.name?(y(),v("span",rs,"(login="+_(e.user.user)+",",1)):(y(),v("span",ns,"(")),r("span",null,"uid="+_(e.user.uid)+",",1),r("span",null,"gid="+_(e.user.gid)+")",1)])])]),r("div",is,[r("div",ls,[cs,e.processing?(y(),P(p,{key:0,class:"size-icon"})):D("",!0)]),f(S,{user:e.user,onApplyChanges:e.applyChanges},{default:b(()=>[r("button",{class:"btn btn-danger",onClick:s[0]||(s[0]=o=>e.deleteConfirmation.showModal=!0),disabled:e.user.uid==="0"||e.user.isCurrentLoggedIn,title:e.user.uid==="0"?"Cannot delete root.":e.user.isCurrentLoggedIn?"Cannot delete self.":""},[r("div",us,[hs,f(u,{class:"size-icon"})])],8,ds),r("button",{class:"btn btn-danger",onClick:s[1]||(s[1]=o=>e.terminateConfirmation.showModal=!0),disabled:e.user.uid==="0",title:e.user.uid==="0"?"Cannot terminate root session.":`Send HUP to all processes owned by ${e.user.user}`},[r("div",fs,[ms,f(d,{class:"size-icon"})])],8,ps)]),_:1},8,["user","onApplyChanges"])]),r("div",ys,[r("div",ws,[gs,e.processingCredentials?(y(),P(p,{key:0,class:"size-icon"})):D("",!0)]),r("div",Ss,[f(m,{user:e.user.user,onStartProcessing:s[2]||(s[2]=o=>e.processingCredentials++),onStopProcessing:s[3]||(s[3]=o=>e.processingCredentials--)},null,8,["user"]),f(k,{user:e.user.user,onStartProcessing:s[4]||(s[4]=o=>e.processingCredentials++),onStopProcessing:s[5]||(s[5]=o=>e.processingCredentials--)},null,8,["user"]),f(I,{user:e.user,onStartProcessing:s[6]||(s[6]=o=>e.processingCredentials++),onStopProcessing:s[7]||(s[7]=o=>e.processingCredentials--)},null,8,["user"])])]),r("div",bs,[e.user.user!==void 0?(y(),P(C,{key:0,user:e.user,class:"!border-0"},null,8,["user"])):D("",!0)])]),f(a,{showModal:e.deleteConfirmation.showModal,onApply:e.deleteConfirmation.applyCallback,onCancel:e.deleteConfirmation.cancelCallback,headerText:`Delete user ${e.user.user}?`,applyText:e.deleteConfirmation.applyText,disableContinue:!e.deleteConfirmation.confirmed,applyDangerous:"",autoWidth:""},{icon:b(()=>[f(M,{class:"size-icon-xl icon-danger"})]),default:b(()=>[r("div",vs,[L(r("input",{type:"checkbox",class:"focus:ring-offset-0 dark:bg-neutral-800 dark:border-neutral-700 dark:checked:bg-red-600 focus:ring-0 focus:outline-none h-4 w-4 text-red-600 border-neutral-300 rounded","onUpdate:modelValue":s[8]||(s[8]=o=>e.deleteConfirmation.removeFiles=o)},null,512),[[de,e.deleteConfirmation.removeFiles]]),r("label",_s,"Remove "+_(e.user.user)+"'s files",1)]),r("div",Cs,[xs,r("span",ks,_(e.deleteConfirmation.confirmationCheck),1),Ps]),L(r("input",{type:"text",class:"input-textlike w-full","onUpdate:modelValue":s[9]||(s[9]=o=>e.deleteConfirmation.confirmationInput=o),onInput:s[10]||(s[10]=(...o)=>e.deleteConfirmation.checkConfirmation&&e.deleteConfirmation.checkConfirmation(...o))},null,544),[[V,e.deleteConfirmation.confirmationInput]])]),_:1},8,["showModal","onApply","onCancel","headerText","applyText","disableContinue"]),f(a,{showModal:e.terminateConfirmation.showModal,onApply:e.terminateConfirmation.applyCallback,onCancel:e.terminateConfirmation.cancelCallback,headerText:`Terminate session for ${e.user.user}?`,applyText:e.terminateConfirmation.applyText,applyDangerous:""},{default:b(()=>[j(" This will attempt to kill all processes owned by "+_(e.user.user)+" with the SIGHUP signal, simulating a logout. ",1)]),_:1},8,["showModal","onApply","onCancel","headerText","applyText"])],64)}var zs=G($e,[["render",Ms]]);export{zs as default};
